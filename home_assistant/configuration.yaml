# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

group: !include groups.yaml
automation: !include automations.yaml
binary_sensor: !include binary_sensors.yaml
sensor: !include sensors.yaml
switch: !include switches.yaml
utility_meter: !include utility_meters.yaml
cover: !include covers.yaml
script: !include scripts.yaml
rest: !include rest.yaml

homeassistant:
  name: Home
  latitude: !secret home_latitude
  longitude: !secret home_longitude
  elevation: !secret home_elevation
  unit_system: metric
  time_zone: "Africa/Johannesburg"
  allowlist_external_dirs:
    - /tmp
    - /mnt/nas/Backups/home_assistant/
    - /sys/class/power_supply/
    - /home/homeassistant/.homeassistant/downloads
  media_dirs:
    gallery: /home/homeassistant/.homeassistant/www/gallery
  customize: !include customize.yaml

logger:
  default: warning
  # logs:
  #   homeassistant.components.openuv: debug
  #   homeassistant.components.tplink: debug
  #   homeassistant.components.shell_command: debug
  #   homeassistant.components.linux_battery: debug
  #   homeassistant.components.automation: info
  #   homeassistant.components.python_script: debug
  #   custom_components.shairport_sync: debug

lovelace:
  mode: yaml
  resources:
    # hacs
    - url: /hacsfiles/button-card/button-card.js
      type: module
    - url: /hacsfiles/lovelace-fold-entity-row/fold-entity-row.js
      type: module
    - url: /hacsfiles/mini-graph-card/mini-graph-card-bundle.js
      type: module
    - url: /hacsfiles/mini-media-player/mini-media-player-bundle.js
      type: module
    - url: /hacsfiles/weather-card/weather-card.js
      type: module
    - url: /hacsfiles/gallery-card/gallery-card.js
      type: module
    - url: /hacsfiles/apexcharts-card/apexcharts-card.js
      type: module
    - url: /hacsfiles/ha-floorplan/floorplan.js
      type: module
    - url: /hacsfiles/lovelace-state-switch/state-switch.js
      type: module
    - url: /hacsfiles/timer-bar-card/timer-bar-card.js
      type: module
    - url: /hacsfiles/atomic-calendar-revive/atomic-calendar-revive.js
      type: module
    - url: /hacsfiles/lovelace-multiple-entity-row/multiple-entity-row.js
      type: module
    - url: /hacsfiles/swipe-card/swipe-card.js
      type: module
    - url: /hacsfiles/battery-state-card/battery-state-card.js
      type: module
    # manual
    - url: /local/floorplan/floorplan-card.js
      type: module
    - url: /local/weather-card-chart/weather-card-chart.js
      type: module

frontend:
  themes: !include_dir_merge_named themes
  extra_module_url:
    - /local/custom.js
    - /hacsfiles/lovelace-card-mod/card-mod.js

recorder:
  db_url: postgresql://@/homeassistant
  # https://community.home-assistant.io/t/home-assistant-db-size/1198/10?u=parautenbach
  # If you set it for 14 days, then it runs after 14 days of UNINTERRUPTED uptime. If you restart your HA server, then the clock restarts from zero again.
  # delete from events where time_fired < datetime('now','-30 days');
  # delete from states where created < datetime('now', '-30 days');
  # SQLite does not recover the disk space after you have done this, so it is necessary to ‘vacuum’ the database. Simply issue the following command:
  # vacuum;
  auto_purge: true
  purge_keep_days: 7

tts:
  - platform: google_translate

apple_tv:

discovery:

stream:

python_script:
# replaced by integration:
# https://raw.githubusercontent.com/bieniu/ha-shellies-discovery/master/python_scripts/shellies_discovery.py

homekit:
  name: Home Assistant
  filter:
    include_entities:
      - input_boolean.test
      - input_boolean.pieter_present
      - input_boolean.rouve_present
      - input_boolean.guest_mode
      - input_boolean.contractor_mode
      - input_boolean.pieter_driving
      - binary_sensor.electricity_feed
      - binary_sensor.internet_connection
      - binary_sensor.motion_detected
      - sensor.conditions_temperature  # from homebridge
      - sensor.conditions_humidity  # from homebridge
      - sensor.living_room_ht_temperature
      - sensor.living_room_ht_humidity
      - sensor.main_bedroom_ht_temperature
      - sensor.main_bedroom_ht_humidity
      - light.living_room_lamp
      - light.pieter_bedside
      - light.rouve_bedside
      - light.dining_room
      - light.foyer
      - light.front_door
      - light.backyard
      - light.garage
      - light.led  # from homebridge
      - switch.tivoli_audio
      - cover.main_gate
      - cover.lhs_garage_door
      - cover.rhs_garage_door
      - script.entertainment_apple_tv_on
      - script.entertainment_satellite_on
      - script.entertainment_off
      - script.open_pedestrian_gap
  entity_config:
    sensor.living_room_ht_temperature:
      linked_battery_sensor: sensor.living_room_ht_battery
    sensor.living_room_ht_humidity:
      linked_battery_sensor: sensor.living_room_ht_battery
    sensor.main_bedroom_ht_temperature:
      linked_battery_sensor: sensor.main_bedroom_ht_battery
    sensor.main_bedroom_ht_humidity:
      linked_battery_sensor: sensor.main_bedroom_ht_battery
    sensor.conditions_temperature:
      name: Living Room Temperature
    sensor.conditions_humidity:
      name: Living Room Humidity
    light.living_room_lamp:
      name: Living Room Lamp
    light.pieter_bedside:
      name: Pieter's Bedside
      linked_battery_sensor: sensor.pieter_bedside_light_button_battery
    light.rouve_bedside:
      name: Rouvé's Bedside
      linked_battery_sensor: sensor.rouve_bedside_light_button_battery
    light.dining_room:
      name: Dining Room
      linked_battery_sensor: sensor.dining_room_light_button_battery
    light.foyer:
      name: Foyer
    light.front_door:
      name: Front Door
    light.backyard:
      name: Backyard
    light.garage:
      name: Garage
    light.led:
      name: Motion LED
    switch.tivoli_audio:
      name: Tivoli Audio
    cover.main_gate:
      name: Main Gate
    cover.lhs_garage_door:
      name: Rouvé's Garage Door
    cover.rhs_garage_door:
      name: Pieter's Garage Door
    script.entertainment_apple_tv_on:
      name: Apple TV Sys On
    script.entertainment_satellite_on:
      name: Satellite Sys On
    script.entertainment_off:
      name: Entertainment Sys Off
    script.open_pedestrian_gap:
      name: Open Pedestrian Gap

ios:

zone:
  - name: Home
    latitude: !secret home_latitude
    longitude: !secret home_longitude
    radius: 22
    icon: mdi:home

camera:
  - platform: ffmpeg
    name: security_camera
    input: -rtsp_transport tcp -i rtsp://securitypi.local:8554/unicast
    # https://stackoverflow.com/questions/37427498/how-to-escape-double-and-single-quotes-in-yaml-within-the-same-string
    # https://stackoverflow.com/questions/6195872/applying-multiple-filters-at-once-with-ffmpeg
    # https://einar.slaskete.net/2011/09/05/adding-time-stamp-overlay-to-video-stream-using-ffmpeg/
    extra_arguments: >-
      -vf "hue=s=0, drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:text='%{localtime\:%Y-%m-%d %T}':fontcolor=white@0.8:x=10:y=10"
  - platform: local_file
    name: security_camera_last_snapshot
    file_path: /home/homeassistant/.homeassistant/www/camera.security_camera_last.jpg
  - platform: ffmpeg
    name: security_camera_last_clip
    input: /home/homeassistant/.homeassistant/www/camera.security_camera_last.mp4

notify:
  - name: family
    platform: group
    services:
      - service: mobile_app_ceres
      - service: mobile_app_rouve

input_boolean:
  test:
    name: Test
  pieter_present:
    name: Pieter Presence
    icon: mdi:account
  rouve_present:
    name: Rouvé Presence
    icon: mdi:account
  guest_mode:
    name: Guest Mode
    icon: mdi:briefcase
  contractor_mode:
    name: Contractor Mode
    icon: mdi:worker
  pieter_driving:
    name: Pieter Driving
    icon: mdi:car
  pieter_bedside_state:
    name: Pieter Bedside State
    icon: mdi:lightbulb
  rouve_bedside_state:
    name: Rouvé Bedside State
    icon: mdi:lightbulb
  dining_room_state:
    name: Dining Room State
    icon: mdi:lightbulb
  foyer_state:
    name: Foyer State
    icon: mdi:lightbulb
  server_power_connected:
    name: Server Power Connected
    icon: mdi:power-plug

input_datetime:
  security_camera_last_snapshot:
    has_date: true
    has_time: true
  security_camera_last_clip:
    has_date: true
    has_time: true
  motion_detected_last:
    has_date: true
    has_time: true
  wake_up_time:
    has_time: true
  vacation_start:
    has_date: true
  vacation_end:
    has_date: true

input_number:
  wan_traffic_delta_in:
    min: 0
    max: 4294967295
  wan_traffic_delta_out:
    min: 0
    max: 4294967295

input_select:
  selected_remote:
    name: Remote
    options:
      - TV
      - Audio
      - Apple TV
      - Satellite
    initial: Audio
    icon: mdi:remote-tv

light:
  - platform: switch
    name: living_room_lamp
    entity_id: switch.living_room_lamp
  - platform: switch
    name: front_door
    entity_id: switch.shelly1_77128c
  - platform: switch
    name: backyard
    entity_id: switch.shelly1_b91f6f
  - platform: switch
    name: garage
    entity_id: switch.shelly1_b95a0e

shell_command:
  noop: ":"
  copy_last_snapshot_image: "cp `ls -t /tmp/camera.security_camera_*.jpg | head -n1` /home/homeassistant/.homeassistant/www/camera.security_camera_last.jpg"
  copy_last_video_clip: "cp `ls -t /tmp/camera.security_camera_*.mp4 | head -n1` /home/homeassistant/.homeassistant/www/camera.security_camera_last.mp4"
  # keep a rolling buffer of n snapshots by always copying only the latest ones and removing the oldest
  # rsync will only copy what's new up to n and the second command will remove what's extra (can't do it with rsync's --delete unless the source is a directory)
  # this is to avoid the distination from growing indefinitely
  sync_snapshots: "rsync -a `ls /tmp/camera.security_camera_*.jpg | sort | tail -n5` /home/homeassistant/.homeassistant/www/gallery/"
  trim_snapshots: "ls /home/homeassistant/.homeassistant/www/gallery/ | sort -r | tail -n +6 | xargs -I {} rm -- /home/homeassistant/.homeassistant/www/gallery/{}"
  shudown_remote_host: "/home/homeassistant/scripts/shutdown_remote_host.sh {{ host }}"
  make_backup: "/home/homeassistant/scripts/backup.sh"
  download_latest_dam_levels: "/home/homeassistant/scripts/download_latest_dam_levels.sh"

timer:
  # format: <entity_id>_timer
  living_room_lamp_timer:
    duration: "00:05:00"
  main_gate_timer:
    duration: "00:03:00"
  lhs_garage_door_timer:
    duration: "00:03:00"
  rhs_garage_door_timer:
    duration: "00:03:00"
  front_door_timer:
    duration: "00:03:00"
  foyer_timer:
    duration: "00:03:00"

media_player:
  - platform: universal
    name: Living Room Universal
    children:
      - media_player.living_room
    commands:
      turn_on:
        service: script.entertainment_apple_tv_on
      turn_off:
        service: script.entertainment_off
      volume_up:
        service: script.hk_3380_vol_up
      volume_down:
        service: script.hk_3380_vol_down
      volume_mute:
        service: script.hk_3380_mute
  - platform: shairport_sync
    name: Main Bedroom
    topic: shairport-sync/main-bedroom
  - platform: universal
    name: Main Bedroom Universal
    children:
      - media_player.main_bedroom
    commands:
      turn_on:
        service: switch.turn_on
        target:
          entity_id: switch.tivoli_audio
      turn_off:
        service: switch.turn_off
        target:
          entity_id: switch.tivoli_audio
    attributes:
      state: switch.tivoli_audio

media_source:

proximity:
  home:  # this refers to zone.home
    zone: home
    devices:
      - device_tracker.ceres
    tolerance: 20
    unit_of_measurement: m

breaking_changes:

google:
  client_id: !secret google_calendar_client_id
  client_secret: !secret google_calendar_client_secret
  track_new_calendar: false

# https://www.dahuasecurity.com/products/All-Products/Video-Intercoms/IP-Products/Door-Stations/VTO2211G-WP
# https://amcrest.com/smarthome-2-megapixel-wireless-doorbell-security-camera-1920-x-1080p-wifi-doorbell-camera-ip55-weatherproof-two-way-audio-ad110.html
# https://www.hikvision.com/en/products/Video-Intercom-Products/
# https://github.com/rroller/dahua
# https://community.home-assistant.io/t/amcrest-doorbell-ad110-api-local-only/223838
# https://community.home-assistant.io/t/dahua-vto-custom-integration/293693
amcrest:
  - name: Doorbell
    host: !secret doorbell_host
    username: !secret doorbell_username
    password: !secret doorbell_password
    binary_sensors:
      - motion_detected
      - online

template:
  - trigger:
      - platform: time_pattern
        minutes: "*"
    sensor:
      # https://community.home-assistant.io/t/sensor-unavailable-offline-detection/147618
      # https://community.home-assistant.io/t/how-to-list-all-sensors-with-state-unavailable-none-or-unknown/154606
      - name: Unavailable Entities
        icon: mdi:help-circle-outline
        state: "{{ states | selectattr('state', 'in', ['unavailable', 'unknown', 'none']) | reject('==', 'sensor.unavailable_entities') | reject('match', 'button') | list | length }}"
        unit_of_measurement: entities
        state_class: measurement
        attributes:
          # buttons don't have state – we don't care about buttons here
          unavailable: "{{ states | selectattr('state', 'in', ['unavailable']) | map(attribute='entity_id') | reject('==', 'sensor.unavailable_entities') | reject('match', 'button') | list }}"
          unknown: "{{ states | selectattr('state', 'in', ['unknown']) | map(attribute='entity_id') | reject('==', 'sensor.unavailable_entities') | reject('match', 'button') | list }}"
          none: "{{ states | selectattr('state', 'in', ['none']) | map(attribute='entity_id') | reject('==', 'sensor.unavailable_entities') | reject('match', 'button') | list }}"
  # Example:
  # {
  #     "event_type": "amcrest",
  #     "data": {
  #         "camera": "Doorbell",
  #         "event": "CallNoAnswered",
  #         "payload": {
  #             "Code": "CallNoAnswered",
  #             "action": "Start",
  #             "index": "0",
  #             "data": {
  #                 "CallID": "3"
  #             }
  #         }
  #     },
  #     "origin": "LOCAL",
  #     "time_fired": "2021-10-16T14:59:57.236917+00:00",
  #     "context": {
  #         "id": "381f8debeef10751b18edc4acf3f4491",
  #         "parent_id": null,
  #         "user_id": null
  #     }
  # }
  - trigger:
    - platform: event
      event_type: amcrest
      event_data:
        event: CallNoAnswered
        payload:
          action: Start
    binary_sensor:
      name: Doorbell Rang
      icon: mdi:bell-outline
      # https://github.com/home-assistant/core/issues/39932
      # icon: "{{ 'mdi:bell-ring-outline' if is_state('binary_sensor.doorbell_rang', 'on') else 'mdi:bell-outline' }}"
      state: true
      auto_off: 5  # seconds

# https://community.home-assistant.io/t/control-recursion-in-the-folder-watcher-integration/200110
# folder_watcher:
#   - folder: /tmp/
#     patterns:
#       - 'camera.security_camera_*.jpg'
