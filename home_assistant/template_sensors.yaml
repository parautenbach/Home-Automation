- trigger:
    - platform: time_pattern
      minutes: "*"
  sensor:
    # https://community.home-assistant.io/t/sensor-unavailable-offline-detection/147618
    # https://community.home-assistant.io/t/how-to-list-all-sensors-with-state-unavailable-none-or-unknown/154606
    - name: Unavailable Entities
      icon: mdi:help-circle-outline
      state: "{{ states | selectattr('state', 'in',['unavailable', 'unknown', 'none']) | rejectattr('domain','eq','button') | map(attribute='entity_id') | reject('==', 'sensor.unavailable_entities') | list | length }}"
      unit_of_measurement: entities
      state_class: measurement
      attributes:
        # buttons don't have state â€“ we don't care about buttons here
        unavailable: "{{ states | selectattr('state', 'in',['unavailable']) | rejectattr('domain','eq','button') | map(attribute='entity_id') | reject('==', 'sensor.unavailable_entities') | list }}"
        unknown: "{{ states | selectattr('state', 'in',['unknown']) | rejectattr('domain','eq','button') | map(attribute='entity_id') | reject('==', 'sensor.unavailable_entities') | list }}"
        none: "{{ states | selectattr('state', 'in',['none']) | rejectattr('domain','eq','button') | map(attribute='entity_id') | reject('==', 'sensor.unavailable_entities') | list }}"
# Example:
# {
#     "event_type": "amcrest",
#     "data": {
#         "camera": "Doorbell",
#         "event": "CallNoAnswered",
#         "payload": {
#             "Code": "CallNoAnswered",
#             "action": "Start",
#             "index": "0",
#             "data": {
#                 "CallID": "3"
#             }
#         }
#     },
#     "origin": "LOCAL",
#     "time_fired": "2021-10-16T14:59:57.236917+00:00",
#     "context": {
#         "id": "381f8debeef10751b18edc4acf3f4491",
#         "parent_id": null,
#         "user_id": null
#     }
# }
- trigger:
  - platform: event
    event_type: amcrest
    event_data:
      event: CallNoAnswered
      payload:
        action: Start
  - platform: state
    entity_id: binary_sensor.doorbell_rang
    to: ~
  binary_sensor:
    name: Doorbell Rang
    # icon: mdi:bell-outline
    # https://github.com/home-assistant/core/issues/39932
    # https://github.com/home-assistant/core/issues/58056
    icon: "{{ 'mdi:bell-ring-outline' if is_state('binary_sensor.doorbell_rang', 'on') else 'mdi:bell-outline' }}"
    state: true
    auto_off: 5  # seconds
