path: environment
title: Environment
icon: mdi:weather-partly-snowy-rainy
badges:
  - entity: sensor.office_temperature
    name: Living Room
    card_mod:
      style: |
        :host {
          --label-badge-text-color:
              {%- from 'dynamic_colors.jinja' import temp_degrees_c_human_map, gradient_color -%}
              {%- set state = states(config.entity) | float(0) -%}
              {{ gradient_color(state, temp_degrees_c_human_map) }}
        }
  - entity: sensor.outside_temperature
    name: Outside
    card_mod:
      style: |
        :host {
          --label-badge-text-color:
              {%- from 'dynamic_colors.jinja' import temp_degrees_c_human_map, gradient_color -%}
              {%- set state = states(config.entity) | float(0) -%}
              {{ gradient_color(state, temp_degrees_c_human_map) }}
        }
  - entity: sensor.overall_pollen_risk
    name: Pollen
    icon: mdi:flower-pollen-outline
    # maybe: https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/1310
    card_mod:
      # style: |
      #   :host {
      #     --label-badge-background-color:
      #         {%- set mapping = {
      #                             1: "#40b100",
      #                             2: "#ffe500",
      #                             3: "#ffa800",
      #                             4: "#ff5800",
      #                             5: "#aa0000" } -%}
      #         {%- set key = states('sensor.overall_pollen_risk') | int(0) -%}
      #         {{ mapping[key] if key in mapping else "" }};
      #   }
      style:
        ha-state-label-badge:
          $:
            ha-label-badge:
              $: |
                .value {
                    color:
                      {%- from 'dynamic_colors.jinja' import discrete_5_point_map, mapped_color -%}
                      {%- set state = states(config.entity) | int(0) -%}
                      {{ mapped_color(state, discrete_5_point_map) }} !important;
                  }
  - entity: sensor.owm_pollution_overall_air_quality
    name: Air
    card_mod:
      style:
        .: |
          :host {
            --label-badge-text-color:
                      {%- from 'dynamic_colors.jinja' import discrete_5_point_map, mapped_color -%}
                      {%- set state = states(config.entity) | int(0) -%}
                      {{ mapped_color(state, discrete_5_point_map) }} !important;
          }
        # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/3319
        # var(--ha-label-badge-font-size);
        ha-state-label-badge $ ha-label-badge $: |
          .badge-container .label-badge .value::after {
            content: "{{ states(config.entity) | float(0) | round(0) }}";
            font-size: var(--paper-font-body1_-_font-size);
          }
          .badge-container .label-badge .value {
            font-size: 0px;
          }
  # https://community.home-assistant.io/t/hours-of-daylight/59422/
  # https://community.home-assistant.io/t/enhanced-sun-component/63553
  - entity: sensor.daylight_hm
    name: Daylight
  - entity: sensor.moon
    name: Moon Phase
cards:
  - type: vertical-stack
    cards:
      - type: glance
        entities:
          - entity: sensor.office_temperature
            name: Living Room
            icon: mdi:sofa-outline
            card_mod:
              style:
                .: |
                  div:nth-child(3) {
                    color:
                      {%- from 'dynamic_colors.jinja' import temp_degrees_c_human_map, gradient_color -%}
                      {%- set state = states(config.entity) | float(0) -%}
                      {{ gradient_color(state, temp_degrees_c_human_map) }}
                  }
          - entity: sensor.main_bedroom_ht_temperature
            name: Main Bedroom
            icon: mdi:bed-king-outline
            card_mod:
              style:
                .: |
                  div:nth-child(3) {
                    color:
                      {%- from 'dynamic_colors.jinja' import temp_degrees_c_human_map, gradient_color -%}
                      {%- set state = states(config.entity) | float(0) -%}
                      {{ gradient_color(state, temp_degrees_c_human_map) }}
                  }
          - entity: sensor.bedroom_ht_temperature
            name: Bedroom
            icon: mdi:bed-single-outline
            card_mod:
              style:
                .: |
                  div:nth-child(3) {
                    color:
                      {%- from 'dynamic_colors.jinja' import temp_degrees_c_human_map, gradient_color -%}
                      {%- set state = states(config.entity) | float(0) -%}
                      {{ gradient_color(state, temp_degrees_c_human_map) }}
                  }
          - entity: sensor.outside_temperature
            name: Outside
            icon: mdi:weather-partly-cloudy
            card_mod:
              style:
                .: |
                  div:nth-child(3) {
                    color:
                      {%- from 'dynamic_colors.jinja' import temp_degrees_c_human_map, gradient_color -%}
                      {%- set state = states(config.entity) | float(0) -%}
                      {{ gradient_color(state, temp_degrees_c_human_map) }}
                  }
      - type: custom:weather-card
        name: Stellies
        entity: weather.openweathermap_hourly
        current: true
        details: true
        forecast: true
        hourly_forecast: true
        number_of_forecasts: 5  # hours
      - type: custom:weather-card
        entity: weather.openweathermap_daily
        current: false
        details: false
        forecast: true
        hourly_forecast: false
        number_of_forecasts: 5  # days
      - type: history-graph
        hours_to_show: 72
        entities:
          - entity: weather.openweathermap_daily
            name: Today
          - entity: weather.forecast_tomorrow
            name: Tomorrow
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: custom:mini-graph-card
            name: Temperature
            entities:
              - entity: sensor.office_temperature
                name: Living Room
                color: var(--custom-color-yellow)
              - entity: sensor.main_bedroom_ht_temperature
                name: Main Bedroom
                color: var(--custom-color-green)
              - entity: sensor.bedroom_ht_temperature
                name: Bedroom
                color: var(--custom-color-magenta)
              - entity: sensor.outside_temperature
                name: Outside
                color: var(--custom-color-red)
              # - entity: sensor.outside_feels_like
              #   name: Feels Like
              #   color: var(--custom-color-magenta)
              - entity: sensor.nighttime_number
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: false
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
              average: true
              labels_secondary: false
          - type: custom:mini-graph-card
            name: Humidity
            entities:
              - entity: sensor.office_humidity
                name: Living Room
                color: var(--custom-color-yellow)
              - entity: sensor.main_bedroom_ht_humidity
                name: Main Bedroom
                color: var(--custom-color-green)
              - entity: sensor.bedroom_ht_humidity
                name: Bedroom
                color: var(--custom-color-magenta)
              - entity: sensor.openweathermap_humidity
                name: Outside
                color: var(--custom-color-red)
              - entity: sensor.nighttime_number
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: false
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 2  # every 30 min
            line_width: 2
            lower_bound: 0
            upper_bound: 100
            show:
              extrema: true
              labels_secondary: false
          - type: custom:mini-graph-card
            name: Temperature Difference
            entities:
              - entity: sensor.temperature_difference
              - entity: sensor.nighttime_number
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            # https://github.com/kalkih/mini-graph-card/issues/764
            lower_bound: -10
            upper_bound: 10
            show:
              legend: false
              extrema: true
              average: true
              labels_secondary: false
            color_thresholds:
              - value: -5
                color: var(--custom-color-blue)
              - value: 0
                color: var(--custom-color-yellow)
              - value: 5
                color: var(--custom-color-red)
      - type: statistics-graph
        entities:
          - entity: sensor.office_temperature
            name: Living Room
          - entity: sensor.main_bedroom_ht_temperature
            name: Main Bedroom
          - entity: sensor.bedroom_ht_temperature
            name: Bedroom
          - entity: sensor.outside_temperature
            name: Outside
        days_to_show: 30
        period: day
        chart_type: line
        stat_types:
          - mean
  - type: vertical-stack
    cards:
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: custom:mini-graph-card
            entities:
              # don't use this if you want to use thresholds: color overrides
              # sensor.sun_illuminance can be very unreliable (operationally); need to use my own light meter
              # - entity: sensor.sun_illuminance
              #   color: var(--custom-color-yellow)
              - entity: sensor.illuminance
                color: var(--custom-color-yellow)
              - entity: sensor.nighttime_number
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: false
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 2
            line_width: 2
            lower_bound: 0
            # https://www.grc.nasa.gov/WWW/k-12/Numbers/Math/Mathematical_Thinking/sun12.htm
            upper_bound: 120000
            show:
              extrema: true
              labels_secondary: false
          - type: custom:mini-graph-card
            entities:
              - entity: sensor.illuminance
                color: var(--custom-color-yellow)
              - entity: sensor.office_illuminance
                color: var(--custom-color-blue)
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 2
            line_width: 2
            lower_bound: 0
            upper_bound: 120000
            show:
              extrema: true
              labels_secondary: hover
      - type: history-graph
        title: Low Light Sensor
        hours_to_show: 24
        entities:
          - entity: binary_sensor.low_light
            name: Low Light
      - type: statistics-graph
        title: Daylight
        entities:
          - sensor.daylight
        days_to_show: 7
        period: day
        chart_type: bar
        stat_types:
          - max
      # https://www.wikihow.com/Compute-the-UV-Index
      # https://www.ehso.com/uvIndexCalc.htm
      # https://www.who.int/news-room/q-a-detail/radiation-ultraviolet-(uv)
      # https://en.wikipedia.org/wiki/Ultraviolet_index
      - type: custom:mini-graph-card
        name: UV
        icon: mdi:weather-sunny-alert
        entities:
          - entity: sensor.openweathermap_uv_index
            name: UV Index
          - entity: sensor.nighttime_number
            color: var(--custom-color-gray)
            show_line: false
            show_points: false
            show_legend: false
            y_axis: secondary
        lower_bound: 0
        upper_bound: 12
        hours_to_show: 24
        hour24: true
        smoothing: true
        points_per_hour: 1
        line_width: 2
        show:
          extrema: true
          labels_secondary: false
        # https://en.wikipedia.org/wiki/Ultraviolet_index
        color_thresholds:
          - value: 0
            color: var(--custom-color-green)
          - value: 5
            color: var(--custom-color-yellow)
          - value: 8
            color: var(--custom-color-red)
          - value: 11
            color: var(--custom-color-magenta)
      - type: entities
        title: Dam Levels
        show_header_toggle: false
        entities:
          - entity: sensor.steenbras_upper_dam_level
            name: Steenbras Upper
          - entity: sensor.steenbras_lower_dam_level
            name: Steenbras Lower
          - entity: sensor.bergrivier_dam_level
            name: Bergrivier
          - entity: sensor.theewaterskloof_dam_level
            name: Theewaterskloof
          - entity: sensor.voelvlei_dam_level
            name: Voëlvlei
          - entity: sensor.wemmershoek_dam_level
            name: Wemmershoek
          - entity: sensor.total_dam_level
            name: Overall
          - entity: sensor.total_dam_level_previous_year
            name: Previous Year
          - entity: sensor.dam_levels_last_update
            name: Last Update
      - type: statistics-graph
        entities:
          - sensor.total_dam_level
        title: Overall Dam Levels
        days_to_show: 90
        period: week
        chart_type: bar
        stat_types:
          - mean
        hide_legend: true
  - type: vertical-stack
    title: Fire
    cards:
      # http://envirowildfire.co.za/the-fire-danger-index/
      # Blue   :  0 –  20 : SAFE           : Cold and wet.
      # Green  : 21 –  45 : MODERATE       : Low fire risk. Care to be taken for burning operations.
      # Yellow : 46 –  60 : DANGEROUS      : Caution advised.
      # Orange : 61 –  75 : VERY DANGEROUS : Teams kept on stand by. No open flames.
      # Red    : 81 – 100 : EXTREME        : Warnings presented on radio and TV forecasts.
      - type: gauge
        name: Fire Risk (FDI)
        entity: sensor.winelands_fdi
        min: 0
        max: 100
        needle: true
        segments:
          - from: 0
            color: "#3498db"
            label: Safe
          - from: 21
            color: "#40b100"
            label: Moderate
          - from: 46
            color: "#ffe500"
            label: Dangerous
          - from: 61
            color: "#ff5800"
            label: Very Dangerous
          - from: 81
            color: "#aa0000"
            label: Extreme
  - type: vertical-stack
    title: Pollen
    cards:
      - type: gauge
        name: Overall Pollen Risk
        entity: sensor.overall_pollen_risk
        min: 0.5
        max: 5.5
        needle: true
        segments:
          - from: 0.5
            color: "#40b100"
            label: Very Low
          - from: 1.5
            color: "#ffe500"
            label: Low
          - from: 2.5
            color: "#ffa800"
            label: Medium
          - from: 3.5
            color: "#ff5800"
            label: High
          - from: 4.5
            color: "#aa0000"
            label: Very High
      # todo: maybe another time
      # - type: custom:button-card
      #   template: pollen
      #   entity: sensor.overall_pollen_risk
      #   # entity_picture: /local/pollen-overall.png
      #   size: 15%
      #   card_size: 1
      #   show_name: false
      #   label: >
      #     [[[
      #       var mapping = {
      #           1: "Very Low",
      #           2: "Low",
      #           3: "Moderate",
      #           4: "High",
      #           5: "Very High"
      #       }
      #       return entity.attributes.friendly_name + ": " + mapping[entity.state];
      #     ]]]
      #   styles:
      #     grid:
      #       - grid-template-areas: '"i l"'
      #       - grid-template-rows: min-content
      #       - grid-template-columns: 1fr 1fr
      #     icon:
      #       # - text-align: right
      #       # - align-self: right
      #       - padding-right: 10px
      #       - padding-left: 80%
      #     # card:
      #     #   - font-size: 16px
      #     card:
      #       - padding: 1%
      #     #   - font-size: 12px
      #     label:
      #       - align-self: left  # middle
      #       - justify-self: left  # center
      #     img_cell:
      #       - margin: none
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            template: pollen
            entity: sensor.tree_pollen
            # entity_picture: /local/pollen-tree.png
          - type: custom:button-card
            template: pollen
            entity: sensor.grass_pollen
            # entity_picture: /local/pollen-grass.png
          - type: custom:button-card
            template: pollen
            entity: sensor.weed_pollen
            # entity_picture: /local/pollen-weed.png
          - type: custom:button-card
            template: pollen
            entity: sensor.mould_spores
            # entity_picture: /local/pollen-mould.png=
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: custom:mini-graph-card
            name: Air Quality
            icon: mdi:lungs
            entities:
              - entity: sensor.owm_pollution_overall_air_quality
                name: AQI
              - entity: sensor.nighttime_number
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: false
                y_axis: secondary
            lower_bound: 0
            upper_bound: 5
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
              labels_secondary: false
            color_thresholds:
              - value: 0
                color: var(--custom-color-green)
              - value: 2
                color: var(--custom-color-yellow)
              - value: 4
                color: var(--custom-color-red)
          - type: custom:mini-graph-card
            name: PM 2.5
            icon: mdi:grain
            entities:
              - entity: sensor.owm_pollution_fine_particles_pm2_5
                name: OWM
              # - entity: sensor.saaqis_pm_2_5
              #   name: SAAQIS
              #   y_axis: secondary
            lower_bound: 0
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
          - type: custom:mini-graph-card
            name: PM 10
            icon: mdi:grain
            entities:
              - entity: sensor.owm_pollution_coarse_particles_pm10
                name: OWM
              # - entity: sensor.saaqis_pm_10
              #   name: SAAQIS
              #   y_axis: secondary
            lower_bound: 0
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
          - type: custom:mini-graph-card
            name: NO₂
            icon: mdi:smog
            entities:
              - entity: sensor.owm_pollution_nitrogen_dioxide_no2
                name: OWM
              - entity: sensor.saaqis_no2
                name: SAAQIS
                y_axis: secondary
            lower_bound: 0
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
          - type: custom:mini-graph-card
            name: SO₂
            icon: mdi:smog
            entities:
              - entity: sensor.owm_pollution_sulphur_dioxide_so2
                name: OWM
              - entity: sensor.saaqis_so2
                name: SAAQIS
                y_axis: secondary
            lower_bound: 0
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
          - type: custom:mini-graph-card
            name: O₃
            icon: mdi:skull-outline
            entities:
              - entity: sensor.owm_pollution_ozone_o3
                name: OWM
              - entity: sensor.saaqis_o3
                name: SAAQIS
                y_axis: secondary
            lower_bound: 0
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
      - type: horizontal-stack
        cards:
          # https://en.wikipedia.org/wiki/Air_quality_index
          # https://www.environment.gov.za/sites/default/files/legislations/nemaqa_airquality_g32816gon1210_0.pdf
          # https://www.airveda.com/blog/AQI-calculation-update
          # https://www.epa.gov/sites/default/files/2016-04/documents/2012_aqi_factsheet.pdf
          - type: gauge
            name: PM2.5
            entity: sensor.owm_pollution_fine_particles_pm2_5
            min: 0
            max: 400
            severity:
              green: 0
              yellow: 90
              red: 180
          - type: gauge
            name: PM10
            entity: sensor.owm_pollution_coarse_particles_pm10
            min: 0
            max: 430
            severity:
              green: 0
              yellow: 100
              red: 250
      - type: horizontal-stack
        cards:
          - type: gauge
            name: NO₂
            entity: sensor.owm_pollution_nitrogen_dioxide_no2
            min: 0
            max: 400
            severity:
              green: 0
              yellow: 80
              red: 180
          - type: gauge
            name: SO₂
            entity: sensor.owm_pollution_sulphur_dioxide_so2
            min: 0
            max: 1600
            severity:
              green: 0
              yellow: 80
              red: 380
          - type: gauge
            name: O₃
            entity: sensor.owm_pollution_ozone_o3
            min: 0
            max: 170
            severity:
              green: 0
              yellow: 100
              red: 170
      - type: horizontal-stack
        cards:
          - type: gauge
            name: "NO"
            entity: sensor.owm_pollution_nitrogen_monoxide_no
            # hard to find these... just setting it the same as for no2
            # https://apps.who.int/iris/bitstream/handle/10665/39555/9241540648-eng.pdf
            min: 0
            max: 400
            severity:
              green: 0
              yellow: 80
              red: 180
          - type: gauge
            name: CO
            entity: sensor.owm_pollution_carbon_monoxide_co
            min: 0
            max: 34000
            severity:
              green: 0
              yellow: 2000
              red: 10000
          - type: gauge
            name: NH₃
            entity: sensor.owm_pollution_ammonia_nh3
            min: 0
            max: 1800
            severity:
              green: 0
              yellow: 400
              red: 800
      - type: entities
        show_header_toggle: true
        entities:
          - entity: sensor.owm_pollution_fine_particles_pm2_5
            type: custom:multiple-entity-row
            name: PM2.5
            state_header: OWM
            # entities:
            #   - entity: sensor.saaqis_pm_2_5
            #     name: SAAQIS
          - entity: sensor.owm_pollution_coarse_particles_pm10
            type: custom:multiple-entity-row
            name: PM10
            state_header: OWM
            # entities:
            #   - entity: sensor.saaqis_pm_10
            #     name: SAAQIS
          - entity: sensor.owm_pollution_nitrogen_dioxide_no2
            type: custom:multiple-entity-row
            name: NO₂
            state_header: OWM
            entities:
              - entity: sensor.saaqis_no2
                name: SAAQIS
          - entity: sensor.owm_pollution_sulphur_dioxide_so2
            type: custom:multiple-entity-row
            name: SO₂
            state_header: OWM
            entities:
              - entity: sensor.saaqis_so2
                name: SAAQIS
          - entity: sensor.owm_pollution_ozone_o3
            type: custom:multiple-entity-row
            name: O₃
            state_header: OWM
            entities:
              - entity: sensor.saaqis_o3
                name: SAAQIS
