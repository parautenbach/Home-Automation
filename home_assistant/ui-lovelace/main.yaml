path: main
title: Main
icon: mdi:home
badges:
  # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/2425
  # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/1396
  # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/1310
  - entity: binary_sensor.ha_updater
    name: Update
    card_mod:
      style:
        ha-state-label-badge:
          $:
            ha-label-badge:
              $: |
                .value {
                    color: {{ "var(--state-binary_sensor-active-color)" if is_state(config.entity, 'on') }} !important;
                  }
  - entity: binary_sensor.foyer_motion_detected
    name: Foyer
    card_mod:
      style:
        ha-state-label-badge:
          $:
            ha-label-badge:
              $: |
                .value {
                  color: {{ "var(--state-binary_sensor-active-color)" if is_state(config.entity, 'on') }} !important;
                }
  - entity: person.pieter_rautenbach
    name: Pieter
  - entity: person.rouve_rautenbach
    name: Rouvé
  - entity: binary_sensor.electricity_feed
    card_mod:
      style:
        ha-state-label-badge:
          $:
            ha-label-badge:
              $: |
                .value {
                  color: {{ "var(--state-binary_sensor-active-color)" if is_state(config.entity, 'on') }} !important;
                }
  - entity: binary_sensor.internet_connection
    card_mod:
      style:
        ha-state-label-badge:
          $:
            ha-label-badge:
              $: |
                .value {
                  color: {{ "var(--state-binary_sensor-active-color)" if is_state(config.entity, 'on') }} !important;
                }
cards:
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        title: Main Bedroom
        cards:
          # todo: light profiles/scenes
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: pieter
            name: Pieter's Side
            entity: light.pieter_bedside
            icon: mdi:lamp
          - type: custom:button-card
            template: rgb_light
            name: Both Sides
            entity: light.main_bedroom_group
            icon: mdi:lamps
            show_label: false
            styles:
              grid:
                - grid-template-areas: '"p s r" "i i i" "n n n"'
                - grid-template-rows: min-content 1fr min-content
                - grid-template-columns: 1fr min-content 1fr
              custom_fields:
                s:
                  - color: var(--paper-item-icon-color)
                p:
                  - align-self: middle
                  - justify-self: end
                  - padding-right: 1ex
                  - color: var(--paper-item-icon-color)
                r:
                  - align-self: middle
                  - justify-self: start
                  - padding-left: 1ex
                  - color: var(--paper-item-icon-color)
            custom_fields:
              s: >
                [[[ return '/'; ]]]
              p: >
                [[[
                  var b = states['light.pieter_bedside'].attributes.brightness;
                  return parseInt(b ? (b/255)*100 : "0") + "%";
                ]]]
              r: >
                [[[
                  var b = states['light.rouve_bedside'].attributes.brightness;
                  return parseInt(b ? (b/255)*100 : "0") + "%";
                ]]]
            tap_action:
              action: call-service
              service: script.toggle_bedlamps
            double_tap_action:
              haptic: medium
              action: call-service
              service: script.toggle_light
              service_data:
                light: "[[[ return entity.entity_id; ]]]"
                profile: security
          # - type: custom:button-card
          #   template: basic
          #   name: Tivoli
          #   entity: switch.tivoli_audio
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: rouve
            name: Rouvé's Side
            entity: light.rouve_bedside
            icon: mdi:lamp
      # scenes: low, default, bright
      - type: horizontal-stack
        title: Inside Lights
        cards:
          - type: custom:button-card
            template:
              - rgb_light
              - rgb_light_with_timer
            variables:
              profile: normal
            name: Foyer
            entity: light.foyer
            icon: mdi:dome-light
          - type: custom:button-card
            template: light_with_timer
            name: Living Room
            entity: light.living_room_lamp
          - type: custom:button-card
            template:
              - rgb_light
              - rgb_light_with_timer
            variables:
              profile: kitchen
            name: Kitchen Counter
            entity: light.kitchen_counter
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: dim
            name: Dining Room
            entity: light.dining_room
            icon: mdi:dome-light
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: normal
            name: Music Room
            entity: light.music_room
            icon: mdi:dome-light
          - type: custom:button-card
            template:
              - rgb_light
              - rgb_light_with_timer
            variables:
              profile: normal
            name: Hallway
            entity: light.hallway
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: corner_white
            name: Dining Room
            entity: light.dining_room_corner_light
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: corner_white
            name: Music Room
            entity: light.music_room_corner_light
          - type: custom:button-card
            template: rgb_light
            name: Open Area
            entity: light.living_area_group
            icon: mdi:lightbulb-group-outline
          # - type: custom:button-card
          #   template: rgb_light
          #   variables:
          #     profile: corner_white
          #   name: Corner Lights
          #   entity: light.corner_lights
      - type: horizontal-stack
        title: Bedroom Lights
        cards:
          - type: custom:button-card
            template:
              - rgb_light
              - rgb_light_with_timer
            variables:
              profile: bedroom_lilac
            name: Bedlamp
            entity: light.bedroom_bedlamp
            icon: mdi:alarm-light-outline
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template:
                  - basic_small
                  - light_preset
                variables:
                  profile: bedlamp_normal
                entity: light.bedroom_bedlamp
                name: Normal
                icon: mdi:brightness-5
              - type: custom:button-card
                template:
                  - basic_small
                  - light_preset
                variables:
                  profile: low
                entity: light.bedroom_bedlamp
                name: Low
                icon: mdi:brightness-6
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template:
                  - basic_small
                  - light_preset
                variables:
                  profile: night
                entity: light.bedroom_bedlamp
                name: Night
                icon: mdi:weather-night
              - type: custom:button-card
                template:
                  - basic_small
                entity: timer.bedroom_bedlamp_timer
                name: Timer
                icon: mdi:camera-timer
                tap_action:
                  action: call-service
                  haptic: light
                  # damn, we can't do pass the duration if we are cancelling the time
                  # we are providing the duration, because we have to provide it here
                  # and in the double tap action, otherwise the service call just uses
                  # whatever the last value was
                  # [[[
                  #   if (entity.state == "idle")
                  #     return "timer.start";
                  #   else
                  #     return "timer.cancel";
                  # ]]]
                  service: >
                    [[[
                      if (states['light.bedroom_bedlamp'].state == "on")
                        return "timer.start";
                    ]]]
                  service_data:
                    entity_id: entity
                    duration: "00:03:00"
                double_tap_action:
                  action: call-service
                  haptic: light
                  service: >
                    [[[
                      if (states['light.bedroom_bedlamp'].state == "on")
                        return "timer.start";
                    ]]]
                  service_data:
                    entity_id: entity
                    duration: "00:15:00"
                hold_action:
                  # timer can be cancelled here
                  action: more-info
                  haptic: heavy
      - type: horizontal-stack
        title: Outside Lights
        cards:
          - type: custom:button-card
            template: light_with_timer
            name: Front Door
            entity: light.front_door
          - type: custom:button-card
            template: basic
            name: Garage
            entity: light.garage
          - type: custom:button-card
            template: basic
            name: Backyard
            entity: light.backyard
      - type: vertical-stack
        title: Entertainment
        cards:
          - type: custom:mini-media-player
            name: Living Room
            entity: media_player.living_room_universal
            artwork: cover
            volume_stateless: true
            source: full
            hide:
              power: true
              volume: false
              mute: true
              runtime: false
              runtime_remaining: false
            idle_view:
              when_idle: false
              when_paused: false
              when_standby: false
            background: '/local/apple_tv.jpg'
            shortcuts:
              columns: 5
              buttons:
                - type: script
                  icon: mdi:apple
                  id: script.entertainment_apple_tv_on
                - type: script
                  icon: mdi:set-top-box
                  id: script.entertainment_satellite_on
                - type: script
                  icon: mdi:palm-tree
                  id: script.play_radio_paradise
                - type: script
                  icon: mdi:white-balance-sunny
                  id: script.hk_3380_dimmer
                - type: script
                  icon: mdi:power
                  id: script.entertainment_off
          - type: custom:mini-media-player
            name: Main Bedroom
            entity: media_player.main_bedroom_universal
            artwork: cover
            volume_stateless: true
            # https://github.com/kalkih/mini-media-player/issues/552
            toggle_power: false  # make it use turn_on/turn_off
            hide:
              power: false
              power_state: false
              volume: false
              mute: true
            idle_view:
              when_idle: false
              when_paused: false
              when_standby: false
            background: '/local/tivoli-model-three.png'
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        title: "Entry & Access"
        cards:
          - type: custom:button-card
            template:
              - cover_with_timer
              - cover_with_occupancy
            variables:
              occupancy_entity: binary_sensor.lhs_garage_occupied
            name: Rouvé
            entity: cover.lhs_garage_door
          - type: custom:button-card
            template:
              - cover_with_timer
            name: Gate
            entity: cover.main_gate
            double_tap_action:
              action: call-service
              haptic: medium
              service: script.turn_on
              service_data:
                entity_id: script.open_pedestrian_gap
          - type: custom:button-card
            template:
              - cover_with_timer
              - cover_with_occupancy
            variables:
              occupancy_entity: binary_sensor.rhs_garage_occupied
            name: Pieter
            entity: cover.rhs_garage_door
      - type: history-graph
        title: Who's Home?
        hours_to_show: 24
        entities:
          - entity: binary_sensor.anybody_home
            name: Anybody
          - entity: binary_sensor.pieter_present
            name: Pieter
          - entity: binary_sensor.rouve_present
            name: Rouvé
          - entity: binary_sensor.tenant_present
            name: Tenant
          - entity: binary_sensor.housekeeper_present
            name: Housekeeper
          - entity: binary_sensor.contractor_mode
            name: Contractors
          - entity: switch.guest_mode
            name: Guests
      - type: entities
        title: Special Modes
        entities:
          - switch.guest_mode
          - switch.contractor_mode
        show_header_toggle: false
      - type: custom:mini-graph-card
        name: Driving – Takealot HQ to Home
        # name: Current Travel Time
        icon: mdi:briefcase-clock
        entities:
          - entity: sensor.google_travel_time
          - entity: sensor.nighttime_number
            color: var(--custom-color-gray)
            show_line: false
            show_points: false
            show_legend: false
            y_axis: secondary
        hours_to_show: 24
        hour24: true
        lower_bound: 0
        smoothing: true
        points_per_hour: 4  # every 15 min
        line_width: 2
        line_color: var(--custom-color-blue)
        show:
          extrema: true
          labels_secondary: false
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        title: Clocks
        cards:
          - type: custom:button-card
            template: clock
            variables:
              timezone: Africa/Johannesburg
            name: Cape Town
            entity: sensor.cape_town
          - type: custom:button-card
            template: clock
            variables:
              timezone: Europe/London
            name: London
            entity: sensor.london
          - type: custom:button-card
            template: clock
            variables:
              timezone: America/Los_Angeles
            name: San Francisco
            entity: sensor.san_francisco
          - type: custom:button-card
            template: clock
            variables:
              timezone: Australia/Sydney
            name: Sydney
            entity: sensor.sydney
      - type: entities
        title: Schedule
        show_header_toggle: false
        entities:
          - entity: automation.switch_on_lights_at_wake_up_time
            name: Automatic Wake-up Lights
          - entity: input_datetime.wake_up_time
            name: Wake-up Time
            # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/3388
            # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/3385
            card_mod:
              style:
                ha-time-input $ ha-base-time-input $:
                  ha-textfield:
                    $: |
                      .mdc-text-field {
                        height: 3em !important;
                      }
                  ha-select:
                    $: |
                      .mdc-select__anchor {
                        height: 3em !important;
                      }
          - entity: input_boolean.skip_next_wake_up_time
            name: Skip Next
          - entity: input_datetime.vacation_start
            name: Vacation Start
            card_mod:
              style:
                ha-date-input $ ha-textfield $: |
                  .mdc-text-field {
                    height: 3em !important;
                  }
          - entity: input_datetime.vacation_end
            name: Vacation End
            card_mod:
              style:
                ha-date-input $ ha-textfield $: |
                  .mdc-text-field {
                    height: 3em !important;
                  }
          - entity: binary_sensor.workday
            name: Workday Today
          - entity: binary_sensor.workday_tomorrow
            name: Workday Tomorrow
      - type: custom:atomic-calendar-revive
        name: Upcoming Events
        showLocation: false
        showMonth: true
        showProgressBar: false
        entities:
          - entity: calendar.vacation
            icon: mdi:palm-tree
          - entity: calendar.housekeeping
            icon: mdi:account-hard-hat
          - entity: calendar.loadshedding
            icon: mdi:flash-alert
