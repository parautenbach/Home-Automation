path: main
title: Main
icon: mdi:home
badges:
  # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/2425
  # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/1396
  # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/1310
  - type: entity
    entity: binary_sensor.ha_updater
    name: Update
    show_icon: true
    show_name: false
    show_state: false
  - type: entity
    entity: binary_sensor.foyer_motion_detected
    name: Foyer
    show_icon: true
    show_name: false
    show_state: false
  - type: entity
    entity: person.pieter_rautenbach
    name: Pieter
    show_entity_picture: true
    show_icon: true
    show_name: true
  - type: entity
    entity: person.rouve_rautenbach
    name: Rouvé
    show_entity_picture: true
    show_icon: true
    show_name: true
  - type: entity
    entity: binary_sensor.electricity_feed
    show_icon: true
    show_name: false
    show_state: false
  - type: entity
    entity: binary_sensor.internet_connection
    show_icon: true
    show_name: false
    show_state: false
cards:
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        title: Main Bedroom
        cards:
          # todo: light profiles/scenes
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: normal_main_bedroom_bedlamps
            name: Pieter's Side
            entity: light.pieter_bedside
            icon: mdi:lamp
          - type: custom:button-card
            template: rgb_light
            name: Both Sides
            entity: light.main_bedroom_group
            icon: mdi:lamps
            show_label: false
            styles:
              grid:
                - grid-template-areas: '"p s r" "i i i" "n n n"'
                - grid-template-rows: min-content 1fr min-content
                - grid-template-columns: 1fr min-content 1fr
              custom_fields:
                s:
                  - color: var(--state-icon-color)
                p:
                  - align-self: middle
                  - justify-self: end
                  - padding-right: 1ex
                  - color: var(--state-icon-color)
                r:
                  - align-self: middle
                  - justify-self: start
                  - padding-left: 1ex
                  - color: var(--state-icon-color)
            custom_fields:
              s: >
                [[[ return '/'; ]]]
              p: >
                [[[
                  var b = states['light.pieter_bedside'].attributes.brightness;
                  return parseInt(b ? (b/255)*100 : "0") + "%";
                ]]]
              r: >
                [[[
                  var b = states['light.rouve_bedside'].attributes.brightness;
                  return parseInt(b ? (b/255)*100 : "0") + "%";
                ]]]
            tap_action:
              action: call-service
              service: script.toggle_bedlamps
            double_tap_action:
              haptic: medium
              action: call-service
              service: script.toggle_light
              service_data:
                light: "[[[ return entity.entity_id; ]]]"
                profile: bright_shelly_duo
          # - type: custom:button-card
          #   template: basic
          #   name: Tivoli
          #   entity: switch.tivoli_audio
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: normal_main_bedroom_bedlamps
            name: Rouvé's Side
            entity: light.rouve_bedside
            icon: mdi:lamp
      - type: horizontal-stack
        title: Bedroom Lights
        cards:
          - type: custom:button-card
            template:
              - rgb_light
              - rgb_light_with_timer
            variables:
              profile: bedlamp_normal
            name: Bedlamp
            entity: light.bedroom_bedlamp
            icon: mdi:alarm-light-outline
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template:
                  - basic_small
                  - light_preset
                variables:
                  profile: lilac_bedlamp
                entity: light.bedroom_bedlamp
                name: Themed
                icon: mdi:brightness-5
              - type: custom:button-card
                template:
                  - basic_small
                  - light_preset
                variables:
                  profile: bedlamp_low
                entity: light.bedroom_bedlamp
                name: Low
                icon: mdi:brightness-6
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template:
                  - basic_small
                  - light_preset
                variables:
                  profile: bedlamp_night
                entity: light.bedroom_bedlamp
                name: Night
                icon: mdi:weather-night
              - type: custom:button-card
                template:
                  - basic_small
                entity: timer.bedroom_bedlamp_timer
                name: Timer
                icon: mdi:camera-timer
                tap_action:
                  action: call-service
                  haptic: light
                  # damn, we can't do pass the duration if we are cancelling the time
                  # we are providing the duration, because we have to provide it here
                  # and in the double tap action, otherwise the service call just uses
                  # whatever the last value was
                  # [[[
                  #   if (entity.state == "idle")
                  #     return "timer.start";
                  #   else
                  #     return "timer.cancel";
                  # ]]]
                  service: >
                    [[[
                      if (states['light.bedroom_bedlamp'].state == "on")
                        return "timer.start";
                    ]]]
                  service_data:
                    entity_id: entity
                    duration: "00:03:00"
                double_tap_action:
                  action: call-service
                  haptic: light
                  service: >
                    [[[
                      if (states['light.bedroom_bedlamp'].state == "on")
                        return "timer.start";
                    ]]]
                  service_data:
                    entity_id: entity
                    duration: "00:15:00"
                hold_action:
                  # timer can be cancelled here
                  action: more-info
                  haptic: heavy
      # scenes: low, default, bright
      - type: horizontal-stack
        title: Other Areas
        cards:
          - type: custom:button-card
            template:
              - rgb_light
              - rgb_light_with_timer
            variables:
              profile: normal_tp_link_rgb
            name: Foyer
            entity: light.foyer
            icon: mdi:dome-light
          - type: custom:button-card
            template:
              - light_with_timer
            name: Living Room
            entity: light.living_room_lamp
          - type: custom:button-card
            template:
              - rgb_light
              - rgb_light_with_timer
            name: Kitchen Counters
            entity: light.kitchen_counter
            tap_action:
              haptic: light
              action: call-service
              service: light.toggle
              data:
                entity_id:
                  - light.kitchen_counter
                  - light.scullery_counter
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: dim_shelly_duo
            name: Dining Room
            entity: light.dining_room
            icon: mdi:dome-light
          - type: custom:button-card
            template: rgb_light
            name: Music Room
            entity: light.music_room
            icon: mdi:dome-light
          - type: custom:button-card
            template: rgb_light
            variables:
              profile: normal_corner_lights_rgb
            name: Corner Lights
            entity: light.corner_lights
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            template: rgb_light
            name: Ceiling Lights
            entity: light.living_areas_ceiling_lights_group
            icon: mdi:lightbulb-group-outline
          - type: custom:button-card
            template:
              - rgb_light
              - rgb_light_with_timer
            variables:
              profile: normal_tp_link_rgb
            name: Hallway
            entity: light.hallway
          - type: custom:button-card
            template: rgb_light
            name: Office
            entity: light.office
            icon: mdi:dome-light
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            template: light_with_timer
            name: Main Bathroom
            entity: switch.main_bathroom_light
          - type: custom:button-card
            template: light_with_timer
            name: Bathroom
            entity: switch.bathroom_light
          - type: custom:button-card
            template: basic
            name: Fairy Lights
            entity: light.living_room_fairy_lights
          # - type: custom:button-card
          #   color_type: blank-card
          # - type: custom:button-card
          #   color_type: blank-card
          # - type: custom:button-card
          #   template: rgb_light
          #   variables:
          #     profile: normal_corner_lights_rgb
          #   name: Dining Room
          #   entity: light.dining_room_corner_light
          # - type: custom:button-card
          #   template: rgb_light
          #   variables:
          #     profile: normal_corner_lights_rgb
          #   name: Music Room
          #   entity: light.music_room_corner_light
          # - type: custom:button-card
          #   template: rgb_light
          #   name: Open Area
          #   entity: light.living_area_group
          #   icon: mdi:lightbulb-group-outline
      - type: horizontal-stack
        title: Yard
        cards:
          - type: custom:button-card
            template: light_with_timer
            name: Front Door
            entity: light.front_door
          - type: custom:button-card
            template: basic
            name: Garage
            entity: light.garage
          - type: custom:button-card
            template: basic
            name: Backyard
            entity: light.backyard
          - type: custom:button-card
            template: basic
            name: Bug Zapper
            entity: switch.bug_zapper
      - type: horizontal-stack
        title: Fans
        cards:
          - type: custom:button-card
            template:
              - fan_with_timer
            name: Main Bathroom
            entity: switch.main_bathroom_fan
          - type: custom:button-card
            template:
              - fan_with_timer
            name: Bathroom
            entity: switch.bathroom_fan
          - type: custom:button-card
            color_type: blank-card
      - type: vertical-stack
        title: Entertainment
        cards:
          - type: custom:mini-media-player
            name: Living Room
            entity: media_player.living_room_universal
            artwork: cover
            volume_stateless: true
            source: full
            hide:
              power: true
              volume: false
              mute: true
              runtime: false
              runtime_remaining: false
            idle_view:
              when_idle: false
              when_paused: false
              when_standby: false
            background: '/local/apple_tv.jpg'
            shortcuts:
              columns: 5
              buttons:
                - type: script
                  icon: mdi:apple
                  id: script.entertainment_apple_tv_on
                - type: script
                  icon: mdi:set-top-box
                  id: script.entertainment_satellite_on
                - type: script
                  icon: mdi:palm-tree
                  id: script.play_radio_paradise
                - type: script
                  icon: mdi:white-balance-sunny
                  id: script.hk_3380_dimmer
                - type: script
                  icon: mdi:power
                  id: script.entertainment_off
                - type: script
                  icon: mdi:volume-minus
                  id: script.hk_3380_vol_down_minus_5
                - type: script
                  icon: mdi:volume-plus
                  id: script.hk_3380_vol_up_plus_5
          - type: custom:mini-media-player
            name: Main Bedroom
            entity: media_player.main_bedroom_universal
            artwork: cover
            volume_stateless: true
            # https://github.com/kalkih/mini-media-player/issues/552
            toggle_power: false  # make it use turn_on/turn_off
            hide:
              power: false
              power_state: false
              volume: false
              mute: true
            idle_view:
              when_idle: false
              when_paused: false
              when_standby: false
            background: '/local/tivoli-model-three.png'
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        title: "Entry & Access"
        cards:
          - type: custom:button-card
            template:
              - cover
            variables:
              occupancy_entity: binary_sensor.garage_doors_lhs_occupied
            name: Rouvé
            entity: cover.garage_doors_lhs
            double_tap_action:
              action: call-service
              haptic: medium
              service: script.close_garage_door_and_main_gate
              service_data:
                garage_door: "[[[ return entity.entity_id; ]]]"
          - type: custom:button-card
            template:
              - cover
            name: Gate
            entity: cover.main_gate
            double_tap_action:
              action: call-service
              haptic: medium
              service: script.turn_on
              service_data:
                entity_id: script.open_pedestrian_gap
          - type: custom:button-card
            template:
              - cover
            variables:
              occupancy_entity: binary_sensor.garage_doors_rhs_occupied
            name: Pieter
            entity: cover.garage_doors_rhs
            double_tap_action:
              action: call-service
              haptic: medium
              service: script.close_garage_door_and_main_gate
              service_data:
                garage_door: "[[[ return entity.entity_id; ]]]"
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: history-graph
            title: Who's Home?
            hours_to_show: 24
            entities:
              - entity: binary_sensor.anybody_home
                name: Anybody
              - entity: binary_sensor.pieter_present
                name: Pieter
              - entity: binary_sensor.rouve_present
                name: Rouvé
              - entity: binary_sensor.tenant_present
                name: Tenant
              - entity: binary_sensor.housekeeper_present
                name: Housekeeper
              - entity: input_boolean.contractor_mode
                name: Contractors
              - entity: input_boolean.guest_mode
                name: Guests
          - type: logbook
            target:
              entity_id:
                - binary_sensor.anybody_home
                - binary_sensor.pieter_present
                - binary_sensor.rouve_present
                - binary_sensor.tenant_present
                - binary_sensor.housekeeper_present
                - input_boolean.contractor_mode
                - input_boolean.guest_mode
            hours_to_show: 1
      - type: entities
        title: Special Modes
        entities:
          - input_boolean.guest_mode
          - input_boolean.contractor_mode
        show_header_toggle: false
      # https://community.home-assistant.io/t/styling-tile-cards/696907/10
      # https://community.home-assistant.io/t/card-mod-for-tile-card-icon-tile-color/657214/52
      # https://community.home-assistant.io/t/olarm-integration/384560/106 (includes css customisations)
      - type: tile
        entity: alarm_control_panel.home
        name: "Home Alarm"
        features:
          - type: "alarm-modes"
            modes:
              - armed_home
              - armed_away
              - disarmed
        card_mod:
          style:
            # button hover colours
            hui-card-features $ hui-card-feature $ hui-alarm-modes-card-feature $ ha-control-select $ div: |
              #option-armed_home {
                --control-select-color: #ffa800 !important;
              }
              #option-armed_away {
                --control-select-color: #aa0000 !important;
              }
              #option-disarmed {
                --control-select-color: #40b100 !important;
              }
            # button and card hover colours
            .: |
              :host {
                --state-alarm_control_panel-armed_home-color: #ffa800 !important;
                --state-alarm_control_panel-armed_away-color: #aa0000 !important;
                --state-alarm_control_panel-disarmed-color: #40b100 !important;
                --state-alarm_control_panel-triggered-color: #135dd8 !important;
              }
              .type-tile {
                --ha-ripple-hover-opacity: 0;
              }
      # todo: panic button (mdi:alert-outline/mdi:shield-alert-outline)
      - type: history-graph
        name: Alarm
        hours_to_show: 24
        entities:
          - entity: alarm_control_panel.home
            name: Alarm
        card_mod:
          style: |
            :host {
              --state-alarm_control_panel-armed_home-color: #ffa800;
              --state-alarm_control_panel-armed_away-color: #aa0000;
              --state-alarm_control_panel-armed_custom_bypass-color: #aa0000;
              --state-alarm_control_panel-disarmed-color: #40b100;
              --state-alarm_control_panel-triggered-color: #135dd8;
            }
      - type: custom:mini-graph-card
        name: Driving – Takealot HQ to Home
        # name: Current Travel Time
        icon: mdi:briefcase-clock-outline
        entities:
          - entity: sensor.google_travel_time
          - entity: sensor.nighttime_number
            color: var(--custom-color-gray)
            show_line: false
            show_points: false
            show_legend: false
            y_axis: secondary
        hours_to_show: 24
        hour24: true
        lower_bound: 0
        smoothing: true
        points_per_hour: 4  # every 15 min
        line_width: 2
        line_color: var(--custom-color-blue)
        show:
          extrema: true
          labels_secondary: false
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        title: Clocks
        cards:
          - type: custom:button-card
            template: clock
            variables:
              timezone: Africa/Johannesburg
            name: Cape Town
            entity: sensor.cape_town
          - type: custom:button-card
            template: clock
            variables:
              timezone: Europe/London
            name: London
            entity: sensor.london
          - type: custom:button-card
            template: clock
            variables:
              timezone: America/Los_Angeles
            name: San Fran.
            entity: sensor.san_francisco
          - type: custom:button-card
            template: clock
            variables:
              timezone: Australia/Sydney
            name: Sydney
            entity: sensor.sydney
      - type: entities
        title: Routine
        show_header_toggle: false
        entities:
          - entity: input_boolean.disable_auto_on_bedlamps
            name: Disable Daytime Auto On Bedlamps
          - entity: automation.run_morning_routine_at_wake_up_time
            name: Automatic Wake-up Lights
          - entity: input_boolean.everyday_routine
            name: Everyday Routine
          - entity: input_datetime.wake_up_time
            name: Wake-up Time
            # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/3388
            # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/3385
            card_mod: &time_input_mods
              style:
                ha-time-input $ ha-base-time-input $:
                  ha-textfield:
                    $: |
                      .mdc-text-field {
                        height: 2.5em !important;
                      }
                  ha-select:
                    $: |
                      .mdc-select__anchor {
                        height: 2.5em !important;
                      }
                # https://community.home-assistant.io/t/card-mod-add-css-styles-to-any-lovelace-card/120744/8844
                hui-generic-entity-row ha-time-input $:
                  ha-base-time-input $ ha-textfield $: |
                    span#label {
                      display: none;
                    }
                    label {
                      align-items: center !important;
                    }
                    .mdc-text-field__affix--suffix {
                      align-content: center;
                    }
          - entity: input_boolean.skip_next_wake_up_time
            name: Skip Next
          - entity: input_datetime.vacation_start
            name: Vacation Start
            card_mod: &date_input_mods
              style:
                ha-date-input $ ha-textfield $: |
                  .mdc-text-field {
                    height: 2.5em !important;
                  }
          - entity: input_datetime.vacation_end
            name: Vacation End
            card_mod: *date_input_mods
          - entity: binary_sensor.workday
            name: Workday Today
          - entity: binary_sensor.workday_tomorrow
            name: Workday Tomorrow
          - entity: input_boolean.trash_reminder
            name: Trash Reminder
          - entity: input_datetime.workday_alarm_arm_reminder
            name: Workday Alarm Arm Reminder
            card_mod: *time_input_mods
          - entity: input_datetime.non_workday_alarm_arm_reminder
            name: Non-workday Alarm Arm Reminder
            card_mod: *time_input_mods
          - entity: input_datetime.go_home_reminder
            name: Go Home Reminder
            card_mod: *time_input_mods
      - type: custom:atomic-calendar-revive
        name: Upcoming Events
        showLocation: false
        showMonth: true
        showProgressBar: false
        entities:
          - entity: calendar.vacation
            icon: mdi:palm-tree
          - entity: calendar.housekeeping
            icon: mdi:account-hard-hat
          - entity: calendar.loadshedding
            icon: mdi:flash-alert
