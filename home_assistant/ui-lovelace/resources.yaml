title: Resources
path: resources
icon: mdi:earth
badges:
  - type: entity
    entity: binary_sensor.electricity_feed
    show_icon: true
    show_name: false
    show_state: false
  - type: entity
    entity: binary_sensor.grid_feed
    show_icon: true
    show_name: false
    show_state: false
  - type: custom:mod-card
    card:
      type: custom:hui-entity-badge
      entity: sensor.home_power_kw
      icon: mdi:home
      show_name: false
      show_icon: true
      show_state: true
    card_mod:
      style:
        hui-entity-badge:
          $: |
            state-display {
              {%- from 'dynamic_colors.jinja' import gradient_color -%}
              {%- set state = states('sensor.home_power_kw') | float(0) -%}
              {%- set consumption_kw_map =
                        {
                          0.0: "#40b100",
                          3.5: "#ffa800",
                          7.0: "#aa0000"
                        }
                -%}
              color: {{ gradient_color(state, consumption_kw_map) }};
            }
  - type: custom:mod-card
    card:
      type: custom:hui-entity-badge
      entity: sensor.solar_reserve_kw
      icon: mdi:solar-power
      show_name: false
      show_icon: true
      show_state: true
    card_mod:
      style:
        hui-entity-badge:
          $: |
            state-display {
              {%- from 'dynamic_colors.jinja' import gradient_color -%}
              {%- set state = states('sensor.solar_reserve_kw') | float(0) -%}
              {%- set reserve_kw_map =
                        {
                          0.5: "#aa0000",
                          1.5: "#ffa800",
                          3.5: "#40b100"
                        }
                -%}
              color: {{ gradient_color(state, reserve_kw_map) }};
            }
  - type: custom:mod-card
    card:
      type: custom:hui-entity-badge
      entity: sensor.solar_reserve_percentage
      name: Solar Reserve
      show_name: false
      show_icon: true
      show_state: true
    card_mod:
      style:
        hui-entity-badge:
          $: |
            state-display {
              {%- from 'dynamic_colors.jinja' import reserve_percentage_map, gradient_color -%}
              {%- set state = states('sensor.solar_reserve_percentage') | int(0) -%}
              color: {{ gradient_color(state, reserve_percentage_map) }};
            }
  - type: custom:mod-card
    card:
      type: custom:hui-entity-badge
      entity: sensor.battery_state_of_charge
      name: Battery
      show_name: false
      show_icon: true
      show_state: true
    card_mod:
      style:
        hui-entity-badge:
          $: |
            state-display {
              {%- from 'dynamic_colors.jinja' import reserve_percentage_map, gradient_color -%}
              {%- set state = states('sensor.battery_state_of_charge') | int(0) -%}
              color: {{ gradient_color(state, reserve_percentage_map) }};
            }
cards:
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        cards:
          # - type: gauge
          #   name: Inverter
          #   entity: sensor.load_power
          #   min: 0
          #   max: 10000
          #   severity:
          #     green: 0
          #     yellow: 5000
          #     red: 7000
          # - type: gauge
          #   name: Current Grid
          #   entity: sensor.grid_power
          #   min: 0
          #   max: 10000
          #   severity:
          #     green: 0
          #     yellow: 5000
          #     red: 7000
          - type: gauge
            name: Today's Solar
            entity: sensor.solar_energy_utilisation_today
            min: 0
            max: 100
            severity:
              green: 0
              yellow: 85
              red: 95
          - type: gauge
            name: Current Solar
            entity: sensor.pv_power
            min: 0
            max: 4140
            severity:
              green: 0
              yellow: 3000
              red: 3800
          - type: gauge
            name: Current Solar
            entity: sensor.solar_consumption_percentage
            min: 0
            max: 100
            severity:
              green: 0
              yellow: 85
              red: 95
          - type: gauge
            name: Battery Buffer
            entity: sensor.battery_charge_variance
            min: -30
            max: 30
            needle: true
            severity:
              green: 10
              yellow: -10
              red: -100
      # https://github.com/ulic75/power-flow-card#inverted-entities-example
      # keeping this as a reference
      # - type: custom:power-flow-card
      #   entities:
      #     grid: sensor.grid_power
      #     battery: sensor.battery_power
      #     battery_charge: sensor.battery_state_of_charge
      #     solar: sensor.pv_power
      #   inverted_entities: battery
      #   watt_threshold: 1000
      #   dashboard_link: /energy
      - type: custom:power-flow-card-plus
        use_new_flow_rate_model: true
        clickable_entities: true
        entities:
          grid:
            entity: sensor.grid_power
            power_outage:
              entity: binary_sensor.grid_feed
              state_alert: "off"
          battery:
            entity: sensor.battery_power
            state_of_charge: sensor.battery_state_of_charge
            invert_state: true
          solar:
            entity: sensor.pv_power
          home:
            entity: sensor.home_power
            override_state: true
          individual:
            - entity: sensor.geyser_power
              name: Geyser
              icon: mdi:water-boiler
              color_icon: false
              display_zero: true
              decimals: 1
            - entity: sensor.outbuilding_power_meter_channel_1_power
              name: Outbuilding
              icon: mdi:garage-variant
              color_icon: false
              display_zero: true
              decimals: 1
            - entity: sensor.acs_power
              name: ACs
              icon: mdi:air-conditioner
              color_icon: false
              display_zero: true
              decimals: 1
            - entity: sensor.home_power_other
              name: Other
              icon: mdi:dots-horizontal
              color_icon: false
              display_zero: true
              decimals: 1
        watt_threshold: 1000
        dashboard_link: /energy
        max_expected_power: 3000  # W
      # - type: entities
      #   entities:
      #     - sensor.living_room_ac_power
      #     - sensor.main_bedroom_ac_power
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: energy-solar-graph
          - type: custom:apexcharts-card
            chart_type: line
            span:
              start: day
              # hack due to the exact time some of these sensors reset
              offset: +1min
            all_series_config:
              stroke_width: 2
              extend_to: now
            apex_config:
              # title:
              #   text: Utilisation
              legend:
                show: true
            series:
              # - entity: sensor.solar_energy_utilisation_today
              #   color: var(--custom-color-yellow)
              #   min: 0
              #   max: 100
              - entity: sensor.average_solar_energy_forecast_today
                name: Forecast
              - entity: sensor.hourly_energy_forecast_aggregated
                name: Aggregated
              - entity: sensor.daily_solar_energy_consumption
                name: Actual
            yaxis:
              - apex_config:
                  title:
                    text: kWh
      - type: horizontal-stack
        cards:
          - type: custom:apexcharts-card
            chart_type: radialBar
            apex_config:
              title:
                text: Utilisation
              legend:
                show: false
              plotOptions: &radial_bar_apex_config_plot_options
                radialBar:
                  startAngle: -173
                  endAngle: 173
                  dataLabels:
                    name:
                      show: false
                    value:
                      show: true
                      fontSize: 10px
                      offsetY: 2
            series:
              - entity: sensor.solar_energy_utilisation_today
                color: var(--custom-color-yellow)
                min: 0
                max: 100
          - type: custom:apexcharts-card
            chart_type: radialBar
            apex_config:
              title:
                text: Production
              legend:
                show: false
              plotOptions: *radial_bar_apex_config_plot_options
            series:
              - entity: sensor.solar_production_share
                color: var(--custom-color-yellow)
                min: 0
                max: 100
          - type: custom:apexcharts-card
            chart_type: radialBar
            apex_config:
              title:
                text: Consumption
              legend:
                show: false
              plotOptions: *radial_bar_apex_config_plot_options
            series:
              - entity: sensor.solar_consumption_share
                color: var(--custom-color-yellow)
                min: 0
                max: 100
      - type: entities
        entities:
          - entity: sensor.average_solar_energy_forecast_today
            name: Production Forecast Today
          - entity: sensor.energy_current_hour
            name: Production Forecast Now
          - entity: sensor.energy_next_hour
            name: Production Forecast Next Hour
          - entity: sensor.energy_production_today_remaining
            name: Remaining Forecast Today
          - entity: sensor.solar_production_peak_today
            name: Peak Time Forecast Today
          - entity: sensor.daily_solar_energy_consumption
            name: Consumption Today
            icon: mdi:solar-power-variant-outline
          - entity: sensor.solar_energy_utilisation_today
            name: Utilisation Today
            # icon: mdi:solar-power-variant-outline
            # card_mod:
            #   style: |
            #     :host {
            #       --card-mod-icon:
            #         {% set index = ((states(config.entity) | int(0))/12.5) | int(0) %}
            #         {% if 0 < index <= 8 %}
            #           mdi:circle-slice-{{ index }}
            #         {% else %}
            #           mdi:circle-outline
            #         {% endif %}
            #     }
          - entity: sensor.solar_production_share
            name: Solar Production Share
          - entity: sensor.solar_consumption_share
            name: Solar Consumption Share
          - entity: sensor.energy_production_tomorrow
            name: Production Forecast Tomorrow
          - entity: sensor.solar_production_peak_tomorrow
            name: Peak Time Forecast Tomorrow
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: custom:mini-graph-card
            name: Solar
            icon: mdi:solar-power-variant-outline
            entities:
              - entity: sensor.pv_power
                name: Consumption
                color: var(--custom-color-yellow)
              - entity: sensor.solar_reserve
                name: Reserve
                color: var(--custom-color-green)
              - entity: sensor.power_production_now
                name: Forecast
                color: var(--custom-color-gray)
              - entity: sensor.nighttime_number
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: false
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            lower_bound: 0
            upper_bound: 6000
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels_secondary: false
          - type: custom:mini-graph-card
            name: Solar
            icon: mdi:solar-power-variant-outline
            entities:
              - entity: sensor.pv_power
                name: Consumption
                color: var(--custom-color-yellow)
              - entity: sensor.solar_consumption_percentage
                name: Consumption %
                color: var(--custom-color-red)
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            lower_bound: 0
            upper_bound: 4200
            lower_bound_secondary: 0
            upper_bound_secondary: 100
            smoothing: true
            points_per_hour: 1
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels_secondary: hover
          - type: custom:mini-graph-card
            name: Solar
            icon: mdi:solar-power-variant-outline
            entities:
              - entity: sensor.pv_power
                name: Consumption
                color: var(--custom-color-yellow)
              - entity: sensor.solar_reserve
                name: Reserve
                color: var(--custom-color-green)
              - entity: sensor.power_production_now
                name: Forecast
                color: var(--custom-color-gray)
              - entity: sensor.weather_based_sun_illuminance
                name: Illuminance
                color: var(--custom-color-magenta)
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 1
            line_width: 2
            lower_bound: 0
            upped_bound: 6000
            lower_bound_secondary: 0
            # keep in sync with environment.yaml
            upper_bound_secondary: 120000
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels_secondary: hover
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: statistics-graph
            title: Daily Solar Consumption
            entities:
              - sensor.daily_solar_energy_consumption
            hide_legend: true
            days_to_show: 7
            period: day
            chart_type: bar
            stat_types:
              - state
          - type: statistics-graph
            title: Daily Solar Utilisation
            entities:
              - sensor.solar_energy_utilisation_today
            hide_legend: true
            days_to_show: 7
            period: day
            chart_type: bar
            stat_types:
              - state
  - type: vertical-stack
    cards:
      - type: energy-date-selection
      # - type: custom:energy-period-selector-plus
      # - type: energy-distribution
      #   link_dashboard: true
      # this seems a bit broken
      - type: custom:energy-flow-card-plus
        energy_date_selection: true
        kwh_decimals: 1
        use_new_flow_rate_model: true
        clickable_entities: true
        display_zero_lines: true
        entities:
          grid:
            entity:
              # this sensor doesn't actually exist; it seems the card interprets an unknown sensor as zero
              # we just want this line drawn, even though we don't export
              production: sensor.zero
              consumption: sensor.daily_grid_energy_consumption
          battery:
            entity:
              production: sensor.battery_energy_in
              consumption: sensor.battery_energy_out
            state_of_charge: sensor.battery_state_of_charge
          solar:
            entity: sensor.daily_solar_energy_consumption
          home:
            entity: sensor.daily_home_energy_consumption
            override_state: true
          individual1:
            entity: sensor.outbuilding_power_meter_channel_1_energy
            name: Outbuilding
            icon: mdi:garage-variant
            color_icon: false
            # cannot use var(--individual-left-bottom-color)
            color: "#964cb5"
            display_zero: true
          individual2:
            entity: sensor.daily_geyser_energy_consumption
            name: Geyser
            icon: mdi:water-boiler
            color_icon: false
            # cannot use var(--individual-left-top-color)
            color: "#d0cc5b"
            display_zero: true
        inverted_entities: battery
        wh_kwh_threshold: 0
        max_expected_energy: 20000
        dashboard_link: /energy
      - type: energy-usage-graph
      - type: custom:sankey-chart
        layout: vertical
        min_state: 0
        height: 200
        unit_prefix: k
        round: 1
        show_states: true
        show_units: true
        show_names: true
        energy_date_selection: true
        sections:
          - entities:
              - entity_id: sensor.pv_energy
                type: entity
                name: Solar
                color: var(--custom-color-yellow)
                children:
                  - sensor.battery_energy_in
                  - sensor.grid_energy_out
                  - total
              - entity_id: sensor.battery_energy_out
                type: entity
                name: Battery
                subtract_entities:
                  - sensor.battery_energy_in
                color: var(--custom-color-magenta)
                children:
                  - sensor.battery_energy_in
                  - sensor.grid_energy_out
                  - total
              - entity_id: sensor.grid_energy_in
                type: entity
                name: Grid In
                subtract_entities:
                  - sensor.grid_energy_out
                color: var(--custom-color-blue)
                children:
                  - sensor.battery_energy_in
                  - sensor.grid_energy_out
                  - total
          - entities:
              - entity_id: sensor.battery_energy_in
                type: entity
                name: Battery In
                subtract_entities:
                  - sensor.battery_energy_out
                color: var(--custom-color-green)
                children: []
              - entity_id: sensor.grid_energy_out
                type: entity
                name: Grid Out
                subtract_entities:
                  - sensor.grid_energy_in
                children: []
              - entity_id: total
                type: remaining_parent_state
                name: Total Consumption
                children:
                  - dining_room
                  - foyer
                  - hallway
                  - kitchen_counter_lights
                  - garage
                  - living_room
                  - music_room
                  - living_room
                  - main_bedroom
                  - non_essential
                  - other
          - entities:
              - entity_id: dining_room
                type: remaining_child_state
                name: Dining Room
                children:
                  - sensor.dining_room_today_s_consumption
              - entity_id: foyer
                type: remaining_child_state
                name: Foyer
                children:
                  - sensor.foyer_today_s_consumption
              - entity_id: hallway
                type: remaining_child_state
                name: Hallway
                children:
                  - sensor.hallway_today_s_consumption
              - entity_id: kitchen_counter_lights
                type: remaining_child_state
                name: Kitchen
                children:
                  - sensor.kitchen_counter_lights_energy
                  - sensor.scullery_counter_lights_energy
              - entity_id: garage
                type: remaining_child_state
                name: Garage
                children:
                  - sensor.outbuilding_power_meter_channel_1_energy
              - entity_id: living_room
                type: remaining_child_state
                name: Living Room
                children:
                  - sensor.office_energy
                  - sensor.living_room_ac_energy
              - entity_id: music_room
                type: remaining_child_state
                name: Music Room
                children:
                  - sensor.music_room_energy
              - entity_id: main_bedroom
                type: remaining_child_state
                name: Main Bedroom
                children:
                  - sensor.main_bedroom_ac_energy
              - entity_id: non_essential
                type: remaining_child_state
                name: Non-essentials
                children:
                  - sensor.geyser_energy
              - entity_id: other
                type: remaining_parent_state
                name: Other
                children:
                  - sensor.inverter_energy
          - entities:
              - entity_id: sensor.dining_room_today_s_consumption
                type: entity
                name: Dining Room Light
                children: []
              - entity_id: sensor.foyer_today_s_consumption
                type: entity
                name: Foyer Light
                children: []
              - entity_id: sensor.hallway_today_s_consumption
                type: entity
                name: Hallway Light
                children: []
              - entity_id: sensor.kitchen_counter_lights_energy
                type: entity
                name: Kitchen Counter Light
                children: []
              - entity_id: sensor.scullery_counter_lights_energy
                type: entity
                name: Scullery Counter Light
                children: []
              - entity_id: sensor.outbuilding_power_meter_channel_1_energy
                type: entity
                name: Outbuilding
                children: []
              - entity_id: sensor.office_energy
                type: entity
                name: Office Light
                children: []
              - entity_id: sensor.music_room_energy
                type: entity
                name: Music Room Light
                children: []
              - entity_id: sensor.living_room_ac_energy
                type: entity
                name: Living Room AC
                children: []
              - entity_id: sensor.main_bedroom_ac_energy
                type: entity
                name: Main Bedroom AC
                children: []
              - entity_id: sensor.geyser_energy
                type: entity
                name: Geyser
                children: []
              - entity_id: sensor.inverter_energy
                type: entity
                name: Inverter
                children: []
      # - type: energy-devices-detail-graph
      #   max_devices: 2
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: custom:mini-graph-card
            name: Battery
            icon: mdi:home-battery-outline
            entities:
              - entity: sensor.battery_state_of_charge
                name: Charge
                color: var(--custom-color-blue)
              - entity: sensor.capacity_charge_point
                name: Charge Point
                color: var(--custom-color-gray)
                show_line: true
                show_points: false
                show_legend: true
              - entity: sensor.output_shutdown_capacity
                name: Charge Threshold
                color: var(--custom-color-yellow)
              - entity: sensor.nighttime_number
                name: Day/Night
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: false
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            lower_bound: 0
            upper_bound: 100
            smoothing: true
            points_per_hour: 12
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels: hover
              labels_secondary: false
          - type: custom:mini-graph-card
            name: Battery
            icon: mdi:home-battery-outline
            entities:
              - entity: sensor.battery_state_of_charge
                name: Charge
                color: var(--custom-color-blue)
              - entity: sensor.battery_power
                name: Power
                color: var(--custom-color-red)
                y_axis: secondary
              - entity: sensor.output_shutdown_capacity
                name: Charge Threshold
                color: var(--custom-color-yellow)
            hours_to_show: 24
            hour24: true
            lower_bound: 0
            upper_bound: 100
            smoothing: true
            points_per_hour: 12
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels: hover
              labels_secondary: hover
          - type: custom:mini-graph-card
            name: Battery
            icon: mdi:home-battery-outline
            entities:
              - entity: sensor.battery_power
                name: Power
                color: var(--custom-color-red)
              - entity: sensor.battery_change_of_charge
                name: Rate of Charge
                color: var(--custom-color-yellow)
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 12
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels: hover
              labels_secondary: hover
          - type: custom:mini-graph-card
            name: Battery
            icon: mdi:home-battery-outline
            entities:
              - entity: sensor.battery_charge_variance
                name: Charge Variance
                color: var(--custom-color-blue)
              - entity: sensor.capacity_charge_point
                name: Charge Point
                color: var(--custom-color-gray)
                y_axis: secondary
                show_line: true
                show_points: false
                show_legend: true
            hours_to_show: 24
            hour24: true
            lower_bound: -80
            upper_bound: 80
            lower_bound_secondary: 0
            upper_bound_secondary: 100
            smoothing: true
            points_per_hour: 12
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels: hover
      - type: conditional
        conditions:
          - entity: sensor.battery_status
            state: "Trickling"
        card:
          type: entities
          show_header_toggle: false
          entities:
            - entity: sensor.charge_mode
              name: Charge Mode
              card_mod: &battery_charge_mode_mods
                style:
                  hui-generic-entity-row:
                    $:
                      .: |
                        .state {
                          color:
                            {%- if 'Optimistic' in states(config.entity) -%}
                              var(--custom-color-green);
                            {%- else -%}
                              var(--custom-color-red);
                            {%- endif -%}
                        }
            - entity: sensor.battery_state_of_charge
              name: State of Charge
              card_mod: &battery_state_of_charge_mods
                style:
                  hui-generic-entity-row:
                    $:
                      .: |
                        .state {
                          color:
                            {%- if states(config.entity) | int(0) <= 30 -%}
                              var(--custom-color-red);
                            {%- elif states('sensor.capacity_charge_point') | int(0) - states(config.entity) | int(0) >= 10 -%}
                              var(--custom-color-red);
                            {%- elif states(config.entity) | int(0) >= states('sensor.capacity_charge_point') | int(0) -%}
                              var(--custom-color-green);
                            {%- else -%}
                              var(--custom-color-yellow);
                            {%- endif -%}
                        }
            - entity: sensor.capacity_charge_point
              name: Charge Point Target
            - entity: sensor.output_shutdown_capacity
              name: Charge Threshold
              icon: mdi:close-circle-outline
            - entity: binary_sensor.grid_charge_point_status
              name: Grid Charge Point Status
              card_mod: &grid_charge_point_status_mods
                style:
                  hui-generic-entity-row:
                    $:
                      .: |
                        .state {
                          color:
                            {%- if is_state(config.entity, 'on') -%}
                              var(--custom-color-green);
                            {%- else -%}
                              var(--custom-color-red);
                            {%- endif -%}
                        }
            - entity: sensor.battery_status
              name: Status
              card_mod: &battery_status_mods
                style:
                  hui-generic-entity-row:
                    $:
                      .: |
                        .state {
                          color:
                            {%- if is_state(config.entity, 'Charging') -%}
                              var(--custom-color-green);
                            {%- elif is_state(config.entity, 'Discharging') -%}
                              var(--custom-color-red);
                            {%- else -%}
                              var(--custom-color-yellow);
                            {%- endif -%}
                        }
      - type: conditional
        conditions:
          - entity: sensor.battery_status
            state: "Charging"
        card:
          type: entities
          show_header_toggle: false
          entities:
            - entity: sensor.charge_mode
              name: Charge Mode
              card_mod: *battery_charge_mode_mods
            - entity: sensor.battery_state_of_charge
              name: State of Charge
              card_mod: *battery_state_of_charge_mods
            - entity: sensor.capacity_charge_point
              name: Charge Point Target
            - entity: sensor.output_shutdown_capacity
              name: Charge Threshold
              icon: mdi:close-circle-outline
            - entity: binary_sensor.grid_charge_point_status
              name: Grid Charge Point Status
              card_mod: *grid_charge_point_status_mods
            - entity: sensor.battery_status
              name: Status
              card_mod: *battery_status_mods
            - entity: sensor.battery_power
              name: Power
            - entity: sensor.battery_change_of_charge
              name: Charge Rate
            - type: custom:template-entity-row
              entity: sensor.battery_time_to_full
              name: Time to Full
              state: >-
                {% set duration_minutes = states('sensor.battery_time_to_full') | float(0) // 60 %}
                {% set hours_part = (duration_minutes // 60) | int(0) %}
                {% set minutes_part = (duration_minutes - hours_part*60) | int(0) %}
                {{ '%02i:%02i' % (hours_part, minutes_part) }}
              icon: mdi:timer-check-outline
            - type: attribute
              entity: sensor.battery_time_to_full
              attribute: time_when_full_relative
              # format: datetime
              name: Time when Full
      - type: conditional
        conditions:
          - entity: sensor.battery_status
            state: "Discharging"
        card:
          type: entities
          show_header_toggle: false
          entities:
            - entity: sensor.charge_mode
              name: Charge Mode
              card_mod: *battery_charge_mode_mods
            - entity: sensor.battery_state_of_charge
              name: State of Charge
              card_mod: *battery_state_of_charge_mods
            - entity: sensor.capacity_charge_point
              name: Charge Point Target
            - entity: sensor.output_shutdown_capacity
              name: Charge Threshold
              icon: mdi:close-circle-outline
            - entity: binary_sensor.grid_charge_point_status
              name: Grid Charge Point Status
              card_mod: *grid_charge_point_status_mods
            - entity: sensor.battery_status
              name: Status
              card_mod: *battery_status_mods
            - entity: sensor.battery_power
              name: Power
            - entity: sensor.battery_change_of_charge
              name: Discharge Rate
            - type: custom:template-entity-row
              entity: sensor.battery_time_to_shutdown_threshold
              name: Time to Shutdown
              state: >-
                {% set duration_minutes = states('sensor.battery_time_to_shutdown_threshold') | float(0) // 60 %}
                {% set hours_part = (duration_minutes // 60) | int(0) %}
                {% set minutes_part = (duration_minutes - hours_part*60) | int(0) %}
                {{ '%02i:%02i' % (hours_part, minutes_part) }}
              icon: mdi:timer-cancel-outline
            - type: attribute
              entity: sensor.battery_time_to_shutdown_threshold
              attribute: time_when_at_shutdown_threshold_relative
              format: datetime
              name: Shutdown Time
      - type: entities
        title: Settings
        icon: mdi:cog
        card_mod:
          style: |
            .icon {
              color: var(--paper-item-icon-color);
            }
        show_header_toggle: false
        entities:
          - type: custom:fold-entity-row
            head:
              type: section
              label: Charge Points
            entities:
              - entity: automation.set_charge_points
                name: Automatic Setting
                icon: mdi:map-clock-outline
              - type: custom:multiple-entity-row
                entity: switch.grid_charge_point_1
                name: 01:00-05:00
                icon: mdi:clock-time-four-outline
                state_header: Grid
                style:
                  text-align: right
                card_mod: &grid_charge_mod
                  style: |
                    .state {
                      color: {{ 'var(--custom-color-green)' if is_state(config.entity, 'on') else 'var(--custom-color-red)' }};
                      }
                    }
                tap_action: &tap_action
                  action: more-info
                  haptic: light
                # but, but, but!
                # Note that hold_action and double_tap_action are currently not supported on additional entities.
                # (this is the main entity!?)
                # https://github.com/benct/lovelace-multiple-entity-row/issues/251
                # https://github.com/benct/lovelace-multiple-entity-row/issues/188
                double_tap_action: &double_tap_action
                  action: toggle
                  haptic: medium
                  confirmation: true
                entities:
                  - entity: number.capacity_point_1
                    name: Target
                    style:
                      text-align: right
              - type: custom:multiple-entity-row
                entity: switch.grid_charge_point_2
                name: 05:00-08:00
                icon: mdi:clock-time-four-outline
                state_header: Grid
                style:
                  text-align: right
                card_mod: *grid_charge_mod
                tap_action: *tap_action
                double_tap_action: *double_tap_action
                entities:
                  - entity: number.capacity_point_2
                    name: Target
                    style:
                      text-align: right
              - type: custom:multiple-entity-row
                entity: switch.grid_charge_point_3
                name: 08:00-13:00
                icon: mdi:clock-time-four-outline
                state_header: Grid
                style:
                  text-align: right
                card_mod: *grid_charge_mod
                tap_action: *tap_action
                double_tap_action: *double_tap_action
                entities:
                  - entity: number.capacity_point_3
                    name: Target
                    style:
                      text-align: right
              - type: custom:multiple-entity-row
                entity: switch.grid_charge_point_4
                name: 13:00-17:00
                icon: mdi:clock-time-four-outline
                state_header: Grid
                style:
                  text-align: right
                card_mod: *grid_charge_mod
                tap_action: *tap_action
                double_tap_action: *double_tap_action
                entities:
                  - entity: number.capacity_point_4
                    name: Target
                    style:
                      text-align: right
              - type: custom:multiple-entity-row
                entity: switch.grid_charge_point_5
                name: 17:00-21:00
                icon: mdi:clock-time-four-outline
                state_header: Grid
                style:
                  text-align: right
                card_mod: *grid_charge_mod
                tap_action: *tap_action
                double_tap_action: *double_tap_action
                entities:
                  - entity: number.capacity_point_5
                    name: Target
                    style:
                      text-align: right
              - type: custom:multiple-entity-row
                entity: switch.grid_charge_point_6
                name: 21:00-01:00
                icon: mdi:clock-time-four-outline
                state_header: Grid
                style:
                  text-align: right
                card_mod: *grid_charge_mod
                tap_action: *tap_action
                double_tap_action: *double_tap_action
                entities:
                  - entity: number.capacity_point_6
                    name: Target
                    style:
                      text-align: right
  - type: vertical-stack
    cards:
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: custom:mini-graph-card
            name: Power Consumption
            icon: mdi:home-lightning-bolt-outline
            entities:
              - entity: sensor.home_power
                name: Home
                color: var(--custom-color-red)
              - entity: sensor.grid_power
                name: Grid
                color: var(--custom-color-blue)
              - entity: sensor.geyser_power
                name: Geyser
                color: var(--custom-color-yellow)
              - entity: sensor.outbuilding_power_meter_channel_1_power
                name: Outbuilding
                color: var(--custom-color-green)
              - entity: sensor.nighttime_number
                name: Day/Night
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: false
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            lower_bound: 0
            smoothing: true
            points_per_hour: 30  # every 2 min
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels: hover
              labels_secondary: false
          - type: custom:mini-graph-card
            name: Power Consumption
            icon: mdi:home-lightning-bolt-outline
            entities:
              - entity: sensor.home_power
                name: Home
                color: var(--custom-color-red)
              - entity: sensor.grid_power
                name: Grid
                color: var(--custom-color-blue)
              - entity: sensor.geyser_power
                name: Geyser
                color: var(--custom-color-yellow)
                aggregate_func: last
              - entity: sensor.outbuilding_power_meter_channel_1_power
                name: Outbuilding
                color: var(--custom-color-green)
              - entity: sensor.grid_feed_outage_number
                name: Grid Outage
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: true
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            lower_bound: 0
            smoothing: true
            points_per_hour: 12  # every 5 min
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels: hover
              labels_secondary: false
            card_mod:
              style:
                .: |
                  ha-card {
                    border: 0px;
                  }
          - type: custom:mini-graph-card
            name: Power Consumption
            icon: mdi:home-lightning-bolt-outline
            entities:
              - entity: sensor.home_power
                name: Home
                color: var(--custom-color-red)
              - entity: sensor.grid_power
                name: Grid
                color: var(--custom-color-blue)
              - entity: sensor.electricity_pulse_counter_current_power
                name: Eskom
                color: var(--custom-color-turquoise)
              - entity: sensor.pv_power
                name: Solar
                color: var(--custom-color-yellow)
              - entity: sensor.load_power
                name: Essentials
                color: var(--custom-color-magenta)
              - entity: sensor.load_power_non_essential
                name: Non-essentials
                color: var(--custom-color-gray)
              - entity: sensor.battery_power
                name: Battery
                color: var(--custom-color-green)
              - entity: sensor.grid_feed_outage_number
                name: Grid Outage
                color: var(--custom-color-gray)
                show_line: false
                show_points: false
                show_legend: true
                y_axis: secondary
            hours_to_show: 24
            hour24: true
            smoothing: true
            points_per_hour: 12
            line_width: 2
            show:
              extrema: true
              name: true
              icon: true
              average: true
              state: true
              labels: hover
              labels_secondary: false
      - type: entities
        show_header_toggle: false
        entities:
          - type: custom:multiple-entity-row
            entity: sensor.daily_home_energy_consumption
            name: Today
            icon: mdi:power-plug
            format: precision1
            state_header: Home
            entities:
              - entity: sensor.daily_grid_energy_consumption
                name: Grid
                format: precision1
          - type: custom:multiple-entity-row
            entity: sensor.monthly_home_energy_consumption
            name: This Month
            icon: mdi:power-plug
            format: precision1
            state_header: Home
            entities:
              - entity: sensor.monthly_grid_energy_consumption
                name: Grid
                format: precision1
          - type: custom:multiple-entity-row
            entity: sensor.monthly_home_energy_consumption_forecast
            name: This Month's Forecast
            icon: mdi:trending-up
            format: precision1
            state_header: Home
            entities:
              - entity: sensor.monthly_grid_energy_consumption_forecast
                name: Grid
                format: precision1
      - type: custom:swipe-card
        parameters:
          autoHeight: true
          pagination:
            type: 'bullets'
        cards:
          - type: statistics-graph
            title: Daily Geyser Energy Share
            entities:
              - sensor.geyser_consumption_share
            hide_legend: true
            days_to_show: 7
            period: day
            chart_type: bar
            stat_types:
              - state
          - type: statistics-graph
            title: Daily Geyser Energy
            entities:
              - sensor.daily_geyser_energy_consumption
            hide_legend: true
            days_to_show: 7
            period: day
            chart_type: bar
            stat_types:
              - state
      - type: markdown
        title: Loadshedding
        content: >-
          {{ states('sensor.loadshedding_forecast') }}


          **[UNOFFICIAL ESKOM: HEATMAP](https://unofficialeskom.com/heatmap/)**

          **[GARETH DWYER](https://metabase.dwyer.co.za/public/dashboard/d3b40619-d8f0-4be3-a1f2-99fe5b84e961)**

          **[THE OUTLIER: HEATMAP](https://loadshed.theoutlier.co.za/)**

          **[FRANCOIS THERON'S DASHBOARD](https://grafana.x.fhtheron.net/d/18Esmjc7z/electricity-grid?orgId=4)**
      - type: entities
        entities:
          - entity: binary_sensor.loadshedding_active
            name: Status
          - entity: sensor.loadshedding_stage
            name: Stage
          - type: conditional
            conditions:
              - entity: sensor.loadshedding_stage
                state_not: "No loadshedding"
            row:
              entity: sensor.loadshedding_start_time
              ame: Start Time
          - type: conditional
            conditions:
              - entity: sensor.loadshedding_stage
                state_not: "No loadshedding"
            row:
              entity: sensor.loadshedding_end_time
              name: End Time
          - type: conditional
            conditions:
              - entity: sensor.loadshedding_stage
                state_not: "No loadshedding"
            row:
              entity: timer.loadshedding_duration
              name: Duration Remainder
              type: custom:timer-bar-card
              bar_radius: 4px
          - entity: sensor.eskomsepush_calls_remaining
            name: API Calls Remaining
        show_header_toggle: false
      - type: history-graph
        hours_to_show: 24
        entities:
          - entity: binary_sensor.grid_feed
            name: Grid
          - entity: binary_sensor.electricity_feed
            name: Home
      - type: statistics-graph
        title: Grid Feed Outage Time
        entities:
          - sensor.daily_grid_feed_outage_time
        hide_legend: true
        days_to_show: 7
        period: day
        chart_type: bar
        stat_types:
          - state
      - type: markdown
        content: >
          **[SOLAR ASSISTANT](https://solar-assistant.io/sites)**

          **[SUNSYNK](https://www.sunsynk.net/login)**
